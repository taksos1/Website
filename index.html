<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord OAuth2 Bot Invite & Server List</title>
  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 15px 40px;
    }
    h1 {
      margin-top: 30px;
      font-weight: 700;
      font-size: 2rem;
      color: #5865F2; /* Discord blurple */
      user-select: none;
    }
    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background-color: #5865F2;
      color: white;
      font-weight: 600;
      padding: 12px 25px;
      font-size: 1.1rem;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 10px rgba(88,101,242,0.5);
      user-select: none;
    }
    button:hover {
      background-color: #4752c4;
      box-shadow: 0 4px 15px rgba(88,101,242,0.7);
    }
    button:active {
      background-color: #3b44a1;
    }
    #loginSection {
      margin-top: 80px;
      text-align: center;
    }
    #userInfo {
      max-width: 600px;
      width: 100%;
      margin-top: 20px;
    }
    #serverList {
      margin-top: 25px;
      max-height: 480px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .server {
      border: 1px solid #2f3136;
      padding: 12px 15px;
      margin-bottom: 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      background-color: #2f3136;
      transition: background-color 0.2s ease;
    }
    .server:hover {
      background-color: #40444b;
    }
    .server img {
      width: 52px;
      height: 52px;
      margin-right: 15px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 0 5px rgba(88,101,242,0.7);
    }
    .server div {
      flex-grow: 1;
      user-select: text;
    }
    .invite-btn {
      background-color: #43b581;
      padding: 8px 16px;
      font-size: 1rem;
      font-weight: 700;
      color: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(67,181,129,0.7);
      transition: background-color 0.3s ease;
    }
    .invite-btn:hover {
      background-color: #369a6e;
      box-shadow: 0 4px 15px rgba(67,181,129,0.9);
    }
    .invite-btn:active {
      background-color: #2e7d5a;
    }
    #topPanel {
      width: 100%;
      max-width: 600px;
      margin-top: 20px;
      margin-bottom: 10px;
      padding: 10px 20px;
      background-color: #202225;
      border-radius: 12px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.7);
      user-select: none;
    }
    #topPanel img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
      box-shadow: 0 0 8px #5865F2;
    }
    #usernameDisplay {
      font-weight: 700;
      font-size: 1.2rem;
      color: #e0e0e0;
      flex-grow: 1;
      overflow-wrap: break-word;
    }
    #logoutBtn {
      background-color: #f04747;
      box-shadow: 0 2px 12px rgba(240,71,71,0.7);
      padding: 8px 16px;
      font-weight: 700;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    #logoutBtn:hover {
      background-color: #c53737;
      box-shadow: 0 4px 15px rgba(197,55,55,0.9);
    }
    #logoutBtn:active {
      background-color: #9a2b2b;
    }
    /* Scrollbar styling */
    #serverList::-webkit-scrollbar {
      width: 8px;
    }
    #serverList::-webkit-scrollbar-thumb {
      background-color: #5865F2;
      border-radius: 20px;
    }
    #serverList::-webkit-scrollbar-track {
      background-color: #2f3136;
      border-radius: 20px;
    }
  </style>
</head>
<body>

  <h1>Discord OAuth2 Bot Invite & Server List</h1>

  <div id="loginSection">
    <button id="loginBtn">Login with Discord</button>
  </div>

  <div id="userInfo" style="display:none;">
    <div id="topPanel">
      <img id="userAvatar" src="" alt="User Avatar" />
      <div id="usernameDisplay"></div>
      <button id="logoutBtn">Logout</button>
    </div>

    <h2>Your Admin Servers</h2>
    <div id="serverList"></div>
  </div>

  <script>
    // Config - CHANGE THESE to your app's values
    const clientId = "1279272540073889856"; // your Discord Application client ID
    const redirectUri = window.location.origin + window.location.pathname; // current page url
    const scopes = ["identify", "guilds"]; // scopes we need (guilds for server list)
    const botClientId = "1279272540073889856"; // same bot client id for invite link

    // Elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginSection = document.getElementById("loginSection");
    const userInfo = document.getElementById("userInfo");
    const welcomeMsg = document.getElementById("welcomeMsg");
    const serverList = document.getElementById("serverList");
    const userAvatar = document.getElementById("userAvatar");
    const usernameDisplay = document.getElementById("usernameDisplay");

    // Helper to parse URL hash
    function parseHashParams(hash) {
      const params = {};
      hash.substring(1).split("&").forEach(part => {
        const [key, value] = part.split("=");
        params[key] = decodeURIComponent(value);
      });
      return params;
    }

    // OAuth2 login url with Implicit Grant (response_type=token)
    function getOAuth2Url() {
      return `https://discord.com/api/oauth2/authorize?client_id=${clientId}` +
             `&redirect_uri=${encodeURIComponent(redirectUri)}` +
             `&response_type=token` +
             `&scope=${encodeURIComponent(scopes.join(" "))}` +
             `&prompt=consent`;
    }

    // Logout function
    function logout() {
      localStorage.removeItem("discord_token");
      localStorage.removeItem("discord_user");
      location.href = redirectUri;
    }

    // Render servers where user has Administrator perms
    function renderServers(guilds) {
      serverList.innerHTML = "";
      const adminGuilds = guilds.filter(g => (parseInt(g.permissions) & 0x8) === 0x8); // ADMINISTRATOR bit
      if (adminGuilds.length === 0) {
        serverList.innerHTML = "<p>You don't have Administrator permission in any server.</p>";
        return;
      }
      adminGuilds.forEach(guild => {
        const div = document.createElement("div");
        div.className = "server";

        const iconUrl = guild.icon ?
          `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png?size=64` :
          "https://via.placeholder.com/48?text=No+Icon";

        div.innerHTML = `
          <img src="${iconUrl}" alt="Server Icon" />
          <div>
            <strong>${guild.name}</strong><br/>
            ID: ${guild.id}
          </div>
          <button class="invite-btn" data-guild-id="${guild.id}">Invite Bot</button>
        `;

        // Invite button opens invite URL in new tab
        const inviteBtn = div.querySelector(".invite-btn");
        inviteBtn.addEventListener("click", () => {
          const inviteUrl = `https://discord.com/oauth2/authorize?client_id=${botClientId}&permissions=8&scope=bot&guild_id=${guild.id}&disable_guild_select=true`;
          window.open(inviteUrl, "_blank");
        });

        serverList.appendChild(div);
      });
    }

    // Fetch user info from Discord API
    async function fetchUser(token) {
      const res = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Failed to fetch user info");
      return res.json();
    }

    // Fetch guilds the user is in
    async function fetchGuilds(token) {
      const res = await fetch("https://discord.com/api/users/@me/guilds", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Failed to fetch guilds");
      return res.json();
    }

    // Initialize UI with token (from hash or localStorage)
    async function initWithToken(token) {
      try {
        loginSection.style.display = "none";
        userInfo.style.display = "block";

        // Get user info
        const user = await fetchUser(token);
        localStorage.setItem("discord_user", JSON.stringify(user));
        userAvatar.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64`;
        usernameDisplay.textContent = `${user.username}#${user.discriminator}`;

        // Get guilds
        const guilds = await fetchGuilds(token);
        renderServers(guilds);

        // Save token
        localStorage.setItem("discord_token", token);
      } catch (err) {
        alert("Login failed or token expired. Please login again.");
        logout();
      }
    }

    // Check if we have token in URL hash (Implicit Grant flow)
    const hashParams = parseHashParams(window.location.hash);
    if (hashParams.access_token) {
      const token = hashParams.access_token;
      // Clear hash to clean URL
      history.replaceState(null, null, " ");
      initWithToken(token);
    } else {
      // Check localStorage
      const storedToken = localStorage.getItem("discord_token");
      if (storedToken) {
        initWithToken(storedToken);
      }
    }

    loginBtn.addEventListener("click", () => {
      window.location.href = getOAuth2Url();
    });

    logoutBtn.addEventListener("click", logout);

  </script>
</body>
</html>
