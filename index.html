<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Discord Admin Servers</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  button { padding: 10px 20px; font-size: 16px; }
  ul { list-style: none; padding: 0; }
  li { margin-bottom: 10px; }
  a.invite { color: blue; text-decoration: underline; cursor: pointer; }
</style>
</head>
<body>

<h1>Discord Admin Server Manager</h1>

<div id="loginSection">
  <button id="loginBtn">Sign in with Discord</button>
</div>

<div id="guildsSection" style="display:none;">
  <h2>Your Admin Servers</h2>
  <ul id="guildList"></ul>
  <button id="logoutBtn">Logout</button>
</div>

<script>
  const clientId = '1279272540073889856';
  const redirectUri = window.location.origin + window.location.pathname; // current page without query
  const scope = 'identify guilds';

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginSection = document.getElementById('loginSection');
  const guildsSection = document.getElementById('guildsSection');
  const guildList = document.getElementById('guildList');

  function getAccessTokenFromHash() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }

  async function fetchUserGuilds(token) {
    const res = await fetch('https://discord.com/api/users/@me/guilds', {
      headers: { Authorization: 'Bearer ' + token }
    });
    if (!res.ok) {
      throw new Error('Failed to fetch guilds');
    }
    return res.json();
  }

  function hasAdminPermissions(permissions) {
    // Discord permissions bitwise check for Administrator (0x8)
    return (BigInt(permissions) & 0x8n) === 0x8n;
  }

  function createInviteUrl(guildId) {
    const permissions = 8; // Administrator permission for bot
    return `https://discord.com/oauth2/authorize?client_id=${clientId}&scope=bot&permissions=${permissions}&guild_id=${guildId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}`;
  }

  async function init() {
    const token = getAccessTokenFromHash();

    if (token) {
      // Clear the hash from URL so token isn't visible
      history.replaceState(null, '', window.location.pathname);

      try {
        const guilds = await fetchUserGuilds(token);
        const adminGuilds = guilds.filter(g => hasAdminPermissions(g.permissions));
        if (adminGuilds.length === 0) {
          guildList.innerHTML = '<li>No servers with Administrator permission found.</li>';
        } else {
          guildList.innerHTML = '';
          adminGuilds.forEach(guild => {
            const li = document.createElement('li');
            li.innerHTML = `
              <strong>${guild.name}</strong> (Members: unknown)<br/>
              <a href="${createInviteUrl(guild.id)}" target="_blank" class="invite">Invite Bot to this Server</a>
            `;
            guildList.appendChild(li);
          });
        }

        loginSection.style.display = 'none';
        guildsSection.style.display = 'block';
      } catch (err) {
        alert('Error fetching guilds or invalid token. Please login again.');
        loginSection.style.display = 'block';
        guildsSection.style.display = 'none';
      }
    } else {
      // Not logged in yet
      loginSection.style.display = 'block';
      guildsSection.style.display = 'none';
    }
  }

  loginBtn.addEventListener('click', () => {
    const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(scope)}`;
    window.location.href = authUrl;
  });

  logoutBtn.addEventListener('click', () => {
    // Just reload the page without access token to "logout"
    window.location.href = window.location.pathname;
  });

  init();
</script>

</body>
</html>
